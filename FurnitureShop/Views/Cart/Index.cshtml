@using Newtonsoft.Json;
@{
    ViewData["Title"] = "Cart Page";
    var cart = ViewData["CartItems"] as List<CartItem> ?? new List<CartItem>();
}

<div class="untree_co-section before-footer-section">
    <div class="container">
        <div class="row mb-5">
            <form class="col-md-12" method="post">
                <div class="site-blocks-table">
                    <table class="table">
                        <thead>
                            <tr>
                                <th class="product-thumbnail">Image</th>
                                <th class="product-name">Product</th>
                                <th class="product-price">Price</th>
                                <th class="product-quantity">Quantity</th>
                                <th class="product-total">Total</th>
                                <th class="product-remove">Remove</th>
                            </tr>
                        </thead>
                        <tbody id="cartItems">
                            <!-- Cart items will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </form>
        </div>
        <div class="row">
            <div class="col-md-6">
                <button class="btn btn-black btn-sm btn-block" id="updateCartButton">Update Cart</button>
            </div>
            <div class="col-md-6">
                <a class="btn btn-outline-black btn-sm btn-block" asp-action="Checkout" asp-controller="Cart">Continue Shopping</a>
            </div>
        </div>
        <!-- Tổng tiền -->
        <div class="row mt-4">
            <div class="col-md-6"></div>
            <div class="col-md-6 text-right">
                <h4>Total: <span id="totalAmount">0</span></h4>
            </div>
        </div>
    </div>
</div>
<script>
    // Giỏ hàng từ ViewData (truyền qua Razor)
    var cart = @Html.Raw(Json.Serialize(ViewData["CartItems"]));

    var cartItemsContainer = document.getElementById('cartItems');
    var totalAmountElement = document.getElementById('totalAmount');

    function updateCartDisplay() {
        cartItemsContainer.innerHTML = '';
        let totalAmount = 0;

        cart.forEach(function(item) {
            var itemTotal = item.price * item.quantity;
            totalAmount += itemTotal;

            var row = document.createElement('tr');
            row.innerHTML = `
    <td class="product-thumbnail"><img src="/data/products/${item.image}" alt="Image" class="img-fluid"></td>
    <td class="product-name"><h2 class="h5 text-black">${item.name}</h2></td>
    <td>${item.price}</td>
    <td>
        <div class="input-group mb-3 d-flex align-items-center quantity-container" style="max-width: 120px;">
            <input type="number" class="form-control text-center quantity-amount" value="${item.quantity}" min="1" id="quantity-${item.id}" onchange="updateQuantityFromInput(${item.id})">
        </div>
    </td>
    <td>${itemTotal.toFixed(2)}</td>
    <td><button class="btn btn-black btn-sm" onclick="removeFromCart(${item.id})">X</button></td>
            `;
            cartItemsContainer.appendChild(row);
        });

        totalAmountElement.innerText = totalAmount.toFixed(2);
    }

    function updateQuantityFromInput(itemId) {
        // Lấy số lượng mới từ input
        var newQuantity = document.getElementById(`quantity-${itemId}`).value;

        // Cập nhật số lượng trong giỏ hàng
        var item = cart.find(item => item.id === itemId);
        if (item) {
            item.quantity = parseInt(newQuantity);
        }

        // Gửi giỏ hàng đã cập nhật về lại server (cập nhật Session)
        updateCartInSession(cart);

        // Cập nhật lại giao diện giỏ hàng
        updateCartDisplay();
    }

    function removeFromCart(itemId) {
        // Xóa sản phẩm khỏi giỏ hàng
        cart = cart.filter(item => item.id !== itemId);

        // Gửi giỏ hàng đã cập nhật về lại server (cập nhật Session)
        updateCartInSession(cart);

        // Cập nhật lại giao diện giỏ hàng
        updateCartDisplay();
    }

    // Gửi giỏ hàng về server để cập nhật Session
    function updateCartInSession(cart) {
        // Gửi giỏ hàng về lại server qua Ajax (POST)
        fetch('/Cart/UpdateCart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ cartItems: cart }),
        }).then(response => {
            if (response.ok) {
                console.log('Cart updated successfully');
            }
        }).catch(error => {
            console.error('Error updating cart:', error);
        });
    }

    // Hiển thị giỏ hàng lần đầu
    updateCartDisplay();
</script>


